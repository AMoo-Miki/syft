version: '3.2'
services:
  fulcio-server:
    image: bcallawa/fulcio-bd4d600f674b081a535a886a15cb8d9a
    command: [
      "serve",
      "--host=0.0.0.0",
      "--port=5555",
      "--ca=ephemeralca",
      "--ct-log-url=http://ct_server:6962/test",
      # Uncomment this for production logging
      # "--log_type=prod",
    ]
    restart: always # keep the server running
    ports:
      - "5555:5555"
    volumes:
      - ./config/config.jsn:/etc/fulcio-config/config.json:z
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    depends_on:
      - dex-idp
  dex-idp:
    image: dexidp/dex:v2.30.0
    user: root
    command: [
      "dex",
      "serve",
      "/etc/config/docker-compose-config.yaml",
      ]
    restart: always # keep the server running
    ports:
      - "8888:8888"
    volumes:
      - ./config/dex:/etc/config/:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/auth/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

